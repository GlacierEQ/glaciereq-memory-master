name: ðŸ”’ Memory Master Security Hardening

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6 AM UTC
  workflow_dispatch:

env:
  FORCE_COLOR: 1

jobs:
  memory-security-hardening:
    name: ðŸ§  Memory Master Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      actions: read
      contents: read
      security-events: write
      
    steps:
    - name: ðŸ“¥ Secure Checkout
      uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744  # v4.0.0
      with:
        fetch-depth: 2
        
    - name: ðŸ Setup Python (if needed)
      if: hashFiles('**/*.py', '**/requirements.txt', '**/pyproject.toml') != ''
      uses: actions/setup-python@65d7f2d534ac1bc67fcd62888c5f4f3d2cb2b236  # v4.7.1
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ Setup Node.js (if needed)
      if: hashFiles('**/package.json') != ''
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903  # v6.0.0
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ” Memory System Security Audit
      run: |
        echo "ðŸ§  Running MEMORY MASTER security audit..."
        
        # Python security check
        if [ -f requirements.txt ] || [ -f pyproject.toml ] || find . -name "*.py" -type f | head -1 | grep -q .; then
          echo "ðŸ Python project detected - running security audit"
          python -m pip install --upgrade pip
          pip install safety pip-audit || echo "Security tools install failed"
          
          if [ -f requirements.txt ]; then
            echo "Checking requirements.txt for known vulnerabilities..."
            safety check -r requirements.txt --json --output safety-report.json || echo "Safety check completed with findings"
            pip-audit -r requirements.txt --format=json --output=pip-audit-report.json || echo "Pip audit completed with findings"
          fi
        fi
        
        # Node.js security check
        if [ -f package.json ]; then
          echo "ðŸ“¦ Node.js project detected - running security audit"
          npm audit --json > npm-audit-report.json || echo "NPM audit completed with findings"
        fi
        
        echo "âœ… Memory Master dependency audit complete"
        
    - name: ðŸ” Advanced Security Scanning
      uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe  # v0.12.0
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  # Don't fail build on vulnerabilities
      continue-on-error: true
        
    - name: ðŸ•µï¸ Secret Detection Scan
      uses: trufflesecurity/trufflehog@3f8f9697a01de8b40f0bca28c02f7b56ecb1e97c  # v3.63.2
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
      continue-on-error: true
        
    - name: ðŸ“Š Upload Security Results to GitHub
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true
        
    - name: ðŸ“‹ Generate Memory Master Security Report
      if: always()
      run: |
        echo "ðŸ§  GLACIER EQ MEMORY MASTER SECURITY HARDENING REPORT" > security-report.txt
        echo "=====================================================" >> security-report.txt
        echo "Repository: ${{ github.repository }}" >> security-report.txt
        echo "Branch: ${{ github.ref_name }}" >> security-report.txt
        echo "Scan Date: $(date -u)" >> security-report.txt
        echo "Commit: ${{ github.sha }}" >> security-report.txt
        echo "" >> security-report.txt
        
        if [ -f safety-report.json ]; then
          echo "ðŸ Python Security Issues Found - Check Artifacts" >> security-report.txt
        fi
        
        if [ -f npm-audit-report.json ]; then
          echo "ðŸ“¦ Node.js Security Issues Found - Check Artifacts" >> security-report.txt
        fi
        
        if [ -f trivy-results.sarif ]; then
          echo "ðŸ›¡ï¸ Advanced Security Scan Results Available" >> security-report.txt
        fi
        
        echo "" >> security-report.txt
        echo "âœ… Memory Master security hardening scan completed successfully" >> security-report.txt
        echo "ðŸ” Review Security tab for detailed vulnerability information" >> security-report.txt
        cat security-report.txt
        
    - name: ðŸ“Ž Upload Security Artifacts
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32  # v3.1.3
      if: always()
      with:
        name: memory-master-security-scan-${{ github.run_number }}
        path: |
          security-report.txt
          *-report.json
          trivy-results.sarif
        retention-days: 90